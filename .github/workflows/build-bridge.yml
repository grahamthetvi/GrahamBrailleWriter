name: Build Bridge
on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
    - uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.24.7'
        cache-dependency-path: bridge/go.sum

    - name: Install Linux Dependencies
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc libgtk-3-dev libayatana-appindicator3-dev

    - name: Build Bridge (Linux)
      if: runner.os == 'Linux'
      run: |
        cd bridge
        go build -o graham-bridge-linux-amd64 .
        zip -r graham-bridge-linux.zip graham-bridge-linux-amd64 graham-bridge.desktop

    - name: Setup MSYS2 (Windows)
      if: runner.os == 'Windows'
      uses: msys2/setup-msys2@v2
      with:
        msystem: UCRT64
        update: true
        install: gcc base-devel

    - name: Build Bridge (Windows)
      if: runner.os == 'Windows'
      shell: msys2 {0}
      run: |
        cd bridge
        export PATH="/ucrt64/bin:$PATH"
        go build -ldflags "-H windowsgui" -o graham-bridge-windows.exe .
        powershell -Command "Compress-Archive -Path graham-bridge-windows.exe -DestinationPath graham-bridge-windows.zip"
      env:
        CGO_ENABLED: 1

    - name: Build Bridge (macOS)
      if: runner.os == 'macOS'
      run: |
        cd bridge
        chmod +x build-macos.sh
        ./build-macos.sh
        zip -r graham-bridge-macos.zip "Graham Bridge.app"
      env:
        CGO_ENABLED: 1

    - name: Upload Artifact (Linux)
      if: runner.os == 'Linux'
      uses: actions/upload-artifact@v4
      with:
        name: bridge-linux
        path: bridge/graham-bridge-linux.zip

    - name: Upload Artifact (Windows)
      if: runner.os == 'Windows'
      uses: actions/upload-artifact@v4
      with:
        name: bridge-windows
        path: bridge/graham-bridge-windows.zip

    - name: Upload Artifact (macOS)
      if: runner.os == 'macOS'
      uses: actions/upload-artifact@v4
      with:
        name: bridge-macos
        path: bridge/graham-bridge-macos.zip

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    steps:
      - name: Download Linux Artifact
        uses: actions/download-artifact@v4
        with:
          name: bridge-linux
          path: out

      - name: Download Windows Artifact
        uses: actions/download-artifact@v4
        with:
          name: bridge-windows
          path: out

      - name: Download macOS Artifact
        uses: actions/download-artifact@v4
        with:
          name: bridge-macos
          path: out

      - name: Release
        uses: softprops/action-gh-release@v1
        with:
          name: Graham Bridge ${{ github.ref_name }}
          body: |
            ## Graham Bridge ${{ github.ref_name }}

            A lightweight system-tray app that bridges the Graham Braille Editor web app to your local braille embosser.

            ### Downloads
            | Platform | File |
            |---|---|
            | ü™ü Windows | `graham-bridge-windows.zip` ‚Üí run `graham-bridge-windows.exe` |
            | üêß Linux | `graham-bridge-linux.zip` ‚Üí run `graham-bridge-linux-amd64` + install `.desktop` |
            | üçé macOS | `graham-bridge-macos.zip` ‚Üí open `Graham Bridge.app` |

            ### What's New
            - Debug dashboard at `http://localhost:8080/debug` ‚Äî live print job log, BRF text preview, hex dump, printer list, and test print button
            - Renamed from "Braille Vibe Bridge" to "Graham Bridge"
          files: out/*
